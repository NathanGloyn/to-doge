function Doge(a){function b(){if(!g.length)return"wow";var a=Math.floor(Math.random()*g.length);return g[a]}function c(){var c=a(".text");c.length>50&&c[0].remove();var g=a("<div />").addClass("text");g.addClass(f[Math.floor(Math.random()*f.length)]),g.addClass(e[Math.floor(Math.random()*f.length)]),g.html(b());var h=200*Math.random()+d.left;h<d.left&&(h+=d.left);var i=250*Math.random()+d.top;g.css("left",h+"px"),g.css("top",i+"px"),g.hide(),a("#doge").append(g),g.fadeIn(600)}var d,e=["red","green","blue","yellow","magenta","cyan"],f=["small","medium","big"],g=["wow","much cool","lol"],h=0;this.display=function(){a("#doge").toggle(),d={top:100,left:260},h=a("#doge").width();for(var b=0;25>b;b++)c()}}function List(a,b){function c(a){for(var b=0;b<a.length;b++){var c=JSON.parse(a[b],reviver);c.id>g&&(g=c.id),c.done?f.push(c):e.push(c)}g++}function d(a,b){for(var c=0;c<b.length;c++)if(b[c].id==a)return b[c];return null}var e=[],f=[],g=0;this.storage=a,this.toDo=e,this.done=f,this.add=function(b){var c=new ListItemModel(g,b);return e.push(c),a.store(c.id,JSON.stringify(c)),g++,c},this.markDone=function(b){var c=new Date,g=d(b,e);return f.push(g),g.done=!0,g.dateDone=c,a.store(g.id,JSON.stringify(g)),g},this.loadItems=function(){var d=b.Deferred();return a.load().then(c).then(function(){d.resolve()}),d.promise()}}function ListItemModel(a,b){var c=new Date;this.id=a,this.text=b,this.done=!1,this.dateCreated=c,this.dateDone=null}function reviver(a,b){if(""===a)return b;var c;return"string"==typeof b&&(c=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)(Z)$/.exec(b))?new Date(Date.UTC(+c[1],+c[2]-1,+c[3],+c[4],+c[5],+c[6])):b}function Storage(a,b,c){this.count=0,this.store=function(b,d){var e=a.child("tasks/"+c).child(b);e.set(d)},this.load=function(){var d=b.Deferred();return a.child("tasks/"+c).once("value",function(a){var b=[],c=a.val();for(var e in c){var f=c[e];f=f.substring(0,f.length),b.push(f)}d.resolve(b)},function(){console.log("Loading of tasks failed")}),d.promise()}}function UserActions(a){var b=null;this.login=function(c,d){var e=$.Deferred();return a.authWithPassword({email:c,password:d},function(a,d){console.log("In callback: Error: "+a+", User: "+d),a&&(alert(a),e.reject(a)),d?(console.log("User ID: "+d.uid+", Provider: "+d.provider),b=c,e.resolve(d)):(console.log("logged out"),e.reject())}),e.promise()},this.logout=function(){b=null,a.unauth()},this.resetPassword=function(b){var c=$.Deferred();return a.resetPassword({email:b},function(a){if(a){switch(a.code){case"INVALID_USER":console.log("The specified user account does not exist.");break;default:console.log("Error resetting password:",a)}c.resolve(!1)}else console.log("Password reset email sent successfully!"),c.resolve(!0)}),c.promise()},this.signUp=function(b,c){var d=$.Deferred();return a.createUser({email:b,password:c},function(a,b){if(a){switch(a.code){case"EMAIL_TAKEN":console.log("The new user account cannot be created because the email is already in use.");break;case"INVALID_EMAIL":console.log("The specified email is not a valid email.");break;default:console.log("Error creating user:",a)}d.resolve(!1)}else console.log("Successfully created user account with uid:",b.uid),d.resolve(!0)}),d.promise()},this.changePassword=function(c,d){var e=$.Deferred();return a.changePassword({email:b,oldPassword:c,newPassword:d},function(a){var b="";if(a)switch(a){case"INVALID_PASSWORD":b="existing password is incorrect";break;case"INVALID_USER":b="Unable to find the user details";break;default:b="error trying to change password "+a}e.resolve(b)}),e.promise()}}!function(a,b){function c(){E.loadItems().then(function(){for(var a=0;a<E.toDo.length;a++)r(E.toDo[a],L),J++;for(var c=0;c<E.done.length;c++)r(E.done[c],b("#doneList"))})}function d(){b("body").keypress(s),M.click(o),O.keyup(p),b("#btnAddNewItem").click(q),b("#doge").click(D),b("#submitLogin").click(e),b("#logout").click(f),b("#forgottenPassword").click(g),b("#submitReset").click(h),b("#resetBack").click(i),b("#signUpBack").click(l),b("#submitSignup").click(k),b("#signUp").click(j)}function e(a){a.stopPropagation();var d=b("#email").val(),e=b("#password").val();console.log("Trying to log "+d+" in"),d&&e&&I.login(d,e).then(function(a){var e=a.uid.indexOf(":")+1;F=a.uid.substring(e),b('#userMenu [value="userName"]').text(d),b("#userMenu").val("userName"),E=new List(new Storage(H,b,F),b),c(),console.log("logged in"),b(".tabs").show(),b(".logon").hide()}).fail(function(){alert("Couldn't log in'")})}function f(){console.log("log out called"),F=null,L.children().remove(),b("#doneList").children().remove(),G="",I.logout(),b(".tabs").hide(),b(".logon").show()}function g(a){a.stopPropagation(),b("#userReset").show(),b(".logon").hide()}function h(a){a.stopPropagation();var c=b("#resetEmail").val();c&&I.resetPassword(c).then(function(a){a?b("#resetSent").show():b("#resetFailed").show()}).fail(function(){alert("Failed in calling reset")})}function i(a){a.stopPropagation(),b("#userReset").hide(),b("#resetFailed").hide(),b("#resetSent").hide(),b(".logon").show()}function j(a){a.stopPropagation(),b("#userSignUp").show(),b(".logon").hide()}function k(a){a.stopPropagation();var c=b("#signUpEmail").val(),d=b("#signUpPassword").val();console.log("Trying to sign up "+c),c&&d&&I.signUp(c,d).then(function(a){a?b("#signedUp").show():b("#signUpFailed").show()})}function l(a){a.stopPropagation(),b("#userSignUp").hide(),b("#signUpFailed").hide(),b("#signedUp").hide(),b(".logon").show()}function m(a){var b=a?"visible":"hidden";N.css("visibility",b)}function n(a){var c=b(a.target);if(c.is(":checked")){a.stopPropagation();var d=c.attr("id"),e=d.replace(/item-/gi,""),f=E.markDone(e);K.display(),setTimeout(function(){D(),w(f)},2e3)}}function o(){m(!0),M.hide(),O.focus()}function p(a){13==a.keyCode&&(q(),a.stopPropagation())}function q(){var a=O.val();if(a){var b=E.add(a);r(b,L),J++,t()}}function r(a,b){var c=a.done?v(a):u(a);b.append(c)}function s(a){27===a.keyCode&&(t(),a.preventDefault(),a.stopPropagation())}function t(){O.val(""),m(!1),M.show(),M.focus()}function u(c){var d=b(a.createElement("li")).append(b(a.createElement("input")).attr({id:"item-"+c.id,type:"checkbox"}).click(n)).append(b(a.createElement("label")).attr({"for":"item-"+c.id}).text(c.text));return d}function v(c){var d=b(a.createElement("li")).append(b(a.createElement("span")).text(c.text)).append(b(a.createElement("span")).text(c.dateDone.toLocaleString()).addClass("doneDate"));return d}function w(a){var c=b("label[for='item-"+a.id+"']").parent();c.remove();var d=v(a);b("#doneList").append(d)}function x(){b(".tabs .tab-links a").on("click",function(a){var c=b(this).attr("href");b(".tab"+c).show().siblings().hide(),b(this).parent("li").addClass("active").siblings().removeClass("active"),a.preventDefault()})}function y(){b("#userMenu").change(function(){var a=b("#userMenu option:selected").val();switch(a){case"logOut":f();break;case"userProfile":b("#submitChangePassword").show(),z()}}),A(),b("#submitChangePassword").on("click",function(a){a.preventDefault(),C()}),b("#backToLists").on("click",function(a){a.preventDefault(),b("#userActions").hide(),b(".tabs").show(),b("#backToLists").text("Back"),b("#changeResult").text(""),b("#changeResultContainer").hide(),b("#oldPassword").text(""),b("#newPassword").text(""),b("#confirmPassword").text(""),b("#userMenu").val("userName"),B()})}function z(){b(".tabs").hide(),b("#userActions").show()}function A(){B(),b("#newPassword").keyup(function(){""!==b("#confirmPassword").val()&&B()}),b("#confirmPassword").keyup(function(){""!==b("#newPassword").val()&&B()})}function B(){var a=b("#newPassword").val(),c=b("#confirmPassword").val(),d=!0;""!==a&&""!==c&&(d=a!==c),b("#submitChangePassword").attr("disabled",d)}function C(){var a=b("#existingPassword").val(),c=b("#newPassword").val();I.changePassword(a,c).then(function(a){a?b("#changeResult").text(a):(b("#changeResult").text("Sucessfully change password"),b("#backToLists").text("Back"),b("#submitChangePassword").hide()),b("#changeResultContainer").show()})}function D(){b("#doge div").remove(),b("#doge").toggle()}var E,F=null,G="",H=new Firebase("https://to-doge.firebaseio.com"),I=new UserActions(H),J=0,K=new Doge(b),L=b("#toDoList"),M=b("#btnNewItem"),N=b("#newItemDiv"),O=b("#txtNewItem");b(a).ready(function(){b("#doge").toggle(),x(),y(),d()})}(window.document,window.jQuery);